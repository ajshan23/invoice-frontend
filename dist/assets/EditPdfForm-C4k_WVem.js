import{b as se,r as n,u as re,f as oe,j as e,T as ne,e as I}from"./index-hhKMM5af.js";import{l as ie}from"./cropper-DD5QvWML.js";/* empty css                      */import{a as B}from"./index-C88pvD_q.js";import{P as ce}from"./PageTitle-B1T6w3pI.js";import{S as P,b as z}from"./authConstant-D7ccvCuz.js";import{C as F,a as R}from"./Card-CIyWpKf_.js";import{R as y,C as m}from"./Row-D46S1-Yf.js";import{F as c}from"./FormControl-Bl8iU_n-.js";import{B as u}from"./Button-CwuV16Mp.js";import"./CardHeaderContext-NYcVvM35.js";import"./divWithClassName-IzdvHqeb.js";import"./FormContext-DUKgKx37.js";import"./Button-Ccp68HYs.js";const Ce=()=>{const{user:v}=se(),[N,A]=n.useState(""),[f,k]=n.useState(""),[C,E]=n.useState(""),[i,p]=n.useState([]),[h,x]=n.useState([""]),[M,b]=n.useState(!1),[$,L]=n.useState(""),[D,g]=n.useState(!1),[Q,U]=n.useState(!0),H=re(),{id:w}=oe(),_=n.useRef({}),[T,S]=n.useState({});n.useEffect(()=>{v&&(async()=>{try{const t=await B.get(`${z}/quotation/${w}`,{headers:{Authorization:`Bearer ${v.token}`}});if(t.data.success&&t.data.data){const a=t.data.data;A(a.companyName);const r=new Date(a.date).toISOString().split("T")[0];k(r),E(a.quotationNumber),p(a.items),x(a.terms||[""]);const o={};a.items.forEach((l,te)=>{l.image&&(o[te]=!0)}),S(o)}}catch(t){console.error("Error fetching invoice:",t),d("Failed to load invoice data")}finally{U(!1)}})()},[w,v]);const G=()=>{const s={name:"",price:0,quantity:1,image:"",subItems:[]};p([...i,s])},O=s=>{const t=i.filter((a,r)=>r!==s);p(t)},j=(s,t,a)=>{const r=[...i];if(r[s][t]=a,p(r),t==="image"){const o={...T};delete o[s],S(o)}},W=s=>{const t=[...i];t[s].subItems.push({name:"",price:0,quantity:1}),p(t)},J=(s,t)=>{const a=[...i];a[s].subItems=a[s].subItems.filter((r,o)=>o!==t),p(a)},q=(s,t,a,r)=>{const o=[...i];o[s].subItems[t][a]=r,p(o)},K=(s,t)=>{const a=t.target.files[0];if(a){const r=new FileReader;r.onload=()=>{j(s,"image",r.result)},r.readAsDataURL(a)}},V=(s,t)=>{t&&(_.current[s]=t)},X=s=>{const t=_.current[s];if(t){const a=t.getCroppedCanvas({width:150,height:300});if(a){const r=a.toDataURL();j(s,"image",r),S({...T,[s]:!0})}}},Y=()=>{x([...h,""])},Z=s=>{const t=h.filter((a,r)=>r!==s);x(t)},ee=(s,t)=>{const a=[...h];a[s]=t,x(a)},d=s=>{L(s),b(!0),setTimeout(()=>b(!1),3e3)},ae=async()=>{var s,t;if(b(!1),g(!0),!N||!f||!C){d("Company Name, Date, and Invoice Number are required."),window.scrollTo({top:0,behavior:"smooth"}),g(!1);return}if(i.length===0){d("At least one main item is required."),window.scrollTo({top:0,behavior:"smooth"}),g(!1);return}for(let a=0;a<i.length;a++){const r=i[a];if(!r.name||!r.price||!r.quantity){d("All main item fields (Name, Price, Quantity) are required."),window.scrollTo({top:0,behavior:"smooth"}),g(!1);return}for(let o=0;o<r.subItems.length;o++){const l=r.subItems[o];if(!l.name||!l.price||!l.quantity){d("All sub-item fields (Name, Price, Quantity) are required."),window.scrollTo({top:0,behavior:"smooth"}),g(!1);return}}}if(h.length===0||h.some(a=>!a.trim())){d("At least one term is required."),window.scrollTo({top:0,behavior:"smooth"}),g(!1);return}try{const a={companyName:N,date:f,quotationNumber:C,items:i.map(o=>({name:o.name,price:parseFloat(o.price),quantity:parseInt(o.quantity),image:o.image,subItems:o.subItems.map(l=>({name:l.name,price:parseFloat(l.price),quantity:parseInt(l.quantity),_id:l._id})),_id:o._id})),terms:h.filter(o=>o.trim())},r=await B.put(`${z}/quotation/${w}`,a,{headers:{"Content-Type":"application/json",Authorization:`Bearer ${v.token}`}});if(!r.data.success)throw new Error(r.data.error||"Failed to update invoice");d("Invoice updated successfully!"),setTimeout(()=>{H("/quotation")},1500)}catch(a){console.error("Error updating invoice:",a),d(((t=(s=a.response)==null?void 0:s.data)==null?void 0:t.error)||"Failed to update invoice. Please try again."),window.scrollTo({top:0,behavior:"smooth"})}finally{g(!1)}};return Q?e.jsx("div",{className:"d-flex justify-content-center align-items-center vh-100",children:e.jsx(P,{animation:"border",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{position:"top-end",className:"p-3",children:e.jsxs(I,{onClose:()=>b(!1),show:M,delay:3e3,autohide:!0,children:[e.jsx(I.Header,{children:e.jsx("strong",{className:"me-auto",children:"Notification"})}),e.jsx(I.Body,{children:$})]})}),e.jsx(ce,{title:"Edit Quotation"}),e.jsx(F,{children:e.jsxs(R,{children:[e.jsx("h4",{className:"mb-4",children:"Edit Invoice"}),e.jsx(y,{children:e.jsxs(m,{lg:12,children:[e.jsx(c,{placeholder:"Company Name *",value:N,onChange:s=>A(s.target.value),className:"mb-3"}),e.jsx(c,{type:"date",value:f,onChange:s=>k(s.target.value),className:"mb-3",required:!0}),f&&e.jsxs("small",{className:"text-muted mb-3 d-block",children:["Selected Date:"," ",new Date(f).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g," / ")]}),e.jsx(c,{placeholder:"Invoice Number *",value:C,onChange:s=>E(s.target.value),className:"mb-3"})]})}),i.map((s,t)=>e.jsx(F,{className:"mb-3",children:e.jsxs(R,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-3",children:[e.jsxs("h5",{children:["Main Item ",t+1]}),e.jsx(u,{variant:"danger",size:"sm",onClick:()=>O(t),children:"Remove"})]}),e.jsxs(y,{children:[e.jsxs(m,{lg:6,children:[e.jsx(c,{placeholder:"Item Name *",value:s.name,onChange:a=>j(t,"name",a.target.value),className:"mb-3"}),e.jsx(c,{type:"number",placeholder:"Price *",value:s.price,onChange:a=>j(t,"price",a.target.value),className:"mb-3"}),e.jsx(c,{type:"number",placeholder:"Quantity *",value:s.quantity,onChange:a=>j(t,"quantity",a.target.value),className:"mb-3"})]}),e.jsxs(m,{lg:6,children:[e.jsx(c,{type:"file",accept:"image/*",onChange:a=>K(t,a),className:"mb-3"}),s.image&&e.jsxs(e.Fragment,{children:[e.jsx(ie,{src:s.image,style:{height:200,width:"100%"},aspectRatio:1/2,guides:!0,viewMode:1,minCropBoxWidth:150,minCropBoxHeight:300,onInitialized:a=>V(t,a)}),e.jsxs("div",{className:"mt-2 mb-2 d-flex justify-content-between align-items-center",children:[e.jsx("small",{className:"text-muted",children:"Cropping to 150x300 aspect ratio"}),T[t]&&e.jsx("span",{className:"text-success",children:"âœ“ Image cropped"})]}),e.jsx(u,{variant:"info",onClick:()=>X(t),className:"mt-2",children:"Apply Crop"})]})]})]}),s.subItems.map((a,r)=>e.jsxs(y,{className:"mt-3",children:[e.jsx(m,{lg:4,children:e.jsx(c,{placeholder:"Sub-Item Name *",value:a.name,onChange:o=>q(t,r,"name",o.target.value),className:"mb-3"})}),e.jsx(m,{lg:4,children:e.jsx(c,{type:"number",placeholder:"Price *",value:a.price,onChange:o=>q(t,r,"price",o.target.value),className:"mb-3"})}),e.jsx(m,{lg:4,children:e.jsx(c,{type:"number",placeholder:"Quantity *",value:a.quantity,onChange:o=>q(t,r,"quantity",o.target.value),className:"mb-3"})}),e.jsx(m,{lg:12,className:"d-flex justify-content-end",children:e.jsx(u,{variant:"danger",size:"sm",onClick:()=>J(t,r),children:"Remove Sub-Item"})})]},a._id||r)),e.jsx(u,{variant:"secondary",onClick:()=>W(t),className:"mt-2",children:"Add Sub-Item"})]})},s._id||t)),e.jsx(F,{className:"mb-3",children:e.jsxs(R,{children:[e.jsx("h5",{className:"mb-3",children:"Terms and Conditions"}),h.map((s,t)=>e.jsxs(y,{className:"mb-3",children:[e.jsx(m,{lg:12,children:e.jsx(c,{as:"textarea",rows:3,placeholder:"Enter term *",value:s,onChange:a=>ee(t,a.target.value)})}),e.jsx(m,{lg:12,className:"d-flex justify-content-end mt-2",children:e.jsx(u,{variant:"danger",size:"sm",onClick:()=>Z(t),children:"Remove Term"})})]},t)),e.jsx(u,{variant:"secondary",onClick:Y,className:"mt-2",children:"Add Term"})]})}),e.jsxs("div",{className:"d-flex gap-3 mt-4",children:[e.jsx(u,{variant:"primary",onClick:G,children:"Add Main Item"}),e.jsx(u,{variant:"success",onClick:ae,disabled:D,children:D?e.jsxs(e.Fragment,{children:[e.jsx(P,{as:"span",animation:"border",size:"sm",role:"status","aria-hidden":"true",className:"me-2"}),"Updating..."]}):"Update Invoice"})]})]})})]})};export{Ce as default};
