import{r as l,u as X,f as Y,j as e,T as Z,e as S}from"./index-CipYN5RM.js";import{l as ee}from"./cropper-5DM1ZqV4.js";/* empty css                      */import{a as _}from"./index-C88pvD_q.js";import{P as ae}from"./PageTitle-C5Pc3w6l.js";import{b as k}from"./authConstant-CsT3Fd4n.js";import{C as I,a as q}from"./Card-NUFmdMaY.js";import{R as x,C as m}from"./Row-CNxKcFtr.js";import{F as i}from"./FormControl-DIibaWiA.js";import{B as p}from"./Button-DDpHrx3q.js";import"./CardHeaderContext-D6Fvn56i.js";import"./divWithClassName-CIEjlYvH.js";import"./FormContext-Cqr0V1yK.js";import"./Button-BuEOCE5t.js";const ve=()=>{const[y,R]=l.useState(""),[g,D]=l.useState(""),[b,F]=l.useState(""),[n,u]=l.useState([]),[h,j]=l.useState([""]),[A,f]=l.useState(!1),[P,B]=l.useState(""),M=X(),{id:C}=Y(),E=l.useRef({}),[N,w]=l.useState({});l.useEffect(()=>{(async()=>{try{const t=await _.get(`${k}/invoice/${C}`);if(t.data.success&&t.data.data){const a=t.data.data;R(a.companyName);const r=new Date(a.date).toISOString().split("T")[0];D(r),F(a.invoiceNumber),u(a.items),j(a.terms||[""]);const o={};a.items.forEach((c,V)=>{c.image&&(o[V]=!0)}),w(o)}}catch(t){console.error("Error fetching invoice:",t),d("Failed to load invoice data")}})()},[C]);const z=()=>{const s={name:"",price:0,quantity:1,image:"",subItems:[]};u([...n,s])},U=s=>{const t=n.filter((a,r)=>r!==s);u(t)},v=(s,t,a)=>{const r=[...n];if(r[s][t]=a,u(r),t==="image"){const o={...N};delete o[s],w(o)}},$=s=>{const t=[...n];t[s].subItems.push({name:"",price:0,quantity:1}),u(t)},L=(s,t)=>{const a=[...n];a[s].subItems=a[s].subItems.filter((r,o)=>o!==t),u(a)},T=(s,t,a,r)=>{const o=[...n];o[s].subItems[t][a]=r,u(o)},H=(s,t)=>{const a=t.target.files[0];if(a){const r=new FileReader;r.onload=()=>{v(s,"image",r.result)},r.readAsDataURL(a)}},Q=(s,t)=>{t&&(E.current[s]=t)},G=s=>{const t=E.current[s];if(t){const a=t.getCroppedCanvas({width:150,height:300});if(a){const r=a.toDataURL();v(s,"image",r),w({...N,[s]:!0})}}},O=()=>{j([...h,""])},W=s=>{const t=h.filter((a,r)=>r!==s);j(t)},J=(s,t)=>{const a=[...h];a[s]=t,j(a)},d=s=>{B(s),f(!0),setTimeout(()=>f(!1),3e3)},K=async()=>{var s,t;if(f(!1),!y||!g||!b){d("Company Name, Date, and Invoice Number are required."),window.scrollTo({top:0,behavior:"smooth"});return}if(n.length===0){d("At least one main item is required."),window.scrollTo({top:0,behavior:"smooth"});return}for(let a=0;a<n.length;a++){const r=n[a];if(!r.name||!r.price||!r.quantity){d("All main item fields are required."),window.scrollTo({top:0,behavior:"smooth"});return}for(let o=0;o<r.subItems.length;o++){const c=r.subItems[o];if(!c.name||!c.price||!c.quantity){d("All sub-item fields are required."),window.scrollTo({top:0,behavior:"smooth"});return}}}if(h.length===0||h.some(a=>!a.trim())){d("At least one term is required."),window.scrollTo({top:0,behavior:"smooth"});return}try{const a={companyName:y,date:g,invoiceNumber:b,items:n.map(o=>({name:o.name,price:parseFloat(o.price),quantity:parseInt(o.quantity),image:o.image,subItems:o.subItems.map(c=>({name:c.name,price:parseFloat(c.price),quantity:parseInt(c.quantity),_id:c._id})),_id:o._id})),terms:h.filter(o=>o.trim())},r=await _.put(`${k}/invoice/${C}`,a,{headers:{"Content-Type":"application/json"}});if(!r.data.success)throw new Error(r.data.error||"Failed to update invoice");d("Invoice updated successfully!"),M("/invoice")}catch(a){console.error("Error updating PDF:",a),d(((t=(s=a.response)==null?void 0:s.data)==null?void 0:t.error)||"Failed to update invoice. Please try again."),window.scrollTo({top:0,behavior:"smooth"})}};return e.jsxs(e.Fragment,{children:[e.jsx(Z,{position:"top-end",className:"p-3",children:e.jsxs(S,{onClose:()=>f(!1),show:A,delay:3e3,autohide:!0,children:[e.jsx(S.Header,{children:e.jsx("strong",{className:"me-auto",children:"Notification"})}),e.jsx(S.Body,{children:P})]})}),e.jsx(ae,{title:"Edit Invoice"}),e.jsx(I,{children:e.jsxs(q,{children:[e.jsx("h4",{children:"Edit Invoice"}),e.jsx(x,{children:e.jsxs(m,{lg:12,children:[e.jsx(i,{placeholder:"Company Name *",value:y,onChange:s=>R(s.target.value),className:"mb-3"}),e.jsx(i,{type:"date",value:g,onChange:s=>D(s.target.value),className:"mb-3",required:!0}),g&&e.jsxs("small",{className:"text-muted mb-3 d-block",children:["Selected Date:"," ",new Date(g).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g," / ")]}),e.jsx(i,{placeholder:"Invoice Number *",value:b,onChange:s=>F(s.target.value),className:"mb-3"})]})}),n.map((s,t)=>e.jsx(I,{className:"mb-3",children:e.jsxs(q,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h5",{children:["Main Item ",t+1]}),e.jsx(p,{variant:"danger",size:"sm",onClick:()=>U(t),children:"Remove"})]}),e.jsxs(x,{children:[e.jsxs(m,{lg:6,children:[e.jsx(i,{placeholder:"Item Name *",value:s.name,onChange:a=>v(t,"name",a.target.value),className:"mb-3"}),e.jsx(i,{type:"number",placeholder:"Price *",value:s.price,onChange:a=>v(t,"price",a.target.value),className:"mb-3"}),e.jsx(i,{type:"number",placeholder:"Quantity *",value:s.quantity,onChange:a=>v(t,"quantity",a.target.value),className:"mb-3"})]}),e.jsxs(m,{lg:6,children:[e.jsx(i,{type:"file",accept:"image/*",onChange:a=>H(t,a),className:"mb-3"}),s.image&&e.jsxs(e.Fragment,{children:[e.jsx(ee,{src:s.image,style:{height:200,width:"100%"},aspectRatio:1/2,guides:!0,viewMode:1,minCropBoxWidth:150,minCropBoxHeight:300,onInitialized:a=>Q(t,a)}),e.jsxs("div",{className:"mt-2 mb-2 d-flex justify-content-between align-items-center",children:[e.jsx("small",{className:"text-muted",children:"Cropping to 150x300 aspect ratio"}),N[t]&&e.jsx("span",{className:"text-success",children:"âœ“ Image cropped"})]}),e.jsx(p,{variant:"info",onClick:()=>G(t),className:"mt-2",children:"Apply Crop"})]})]})]}),s.subItems.map((a,r)=>e.jsxs(x,{className:"mt-3",children:[e.jsx(m,{lg:4,children:e.jsx(i,{placeholder:"Sub-Item Name *",value:a.name,onChange:o=>T(t,r,"name",o.target.value),className:"mb-3"})}),e.jsx(m,{lg:4,children:e.jsx(i,{type:"number",placeholder:"Price *",value:a.price,onChange:o=>T(t,r,"price",o.target.value),className:"mb-3"})}),e.jsx(m,{lg:4,children:e.jsx(i,{type:"number",placeholder:"Quantity *",value:a.quantity,onChange:o=>T(t,r,"quantity",o.target.value),className:"mb-3"})}),e.jsx(m,{lg:12,className:"d-flex justify-content-end",children:e.jsx(p,{variant:"danger",size:"sm",onClick:()=>L(t,r),children:"Remove Sub-Item"})})]},a._id||r)),e.jsx(p,{variant:"secondary",onClick:()=>$(t),className:"mt-2",children:"Add Sub-Item"})]})},s._id||t)),e.jsx(I,{className:"mb-3",children:e.jsxs(q,{children:[e.jsx("h5",{children:"Terms and Conditions"}),h.map((s,t)=>e.jsxs(x,{className:"mb-3",children:[e.jsx(m,{lg:12,children:e.jsx(i,{as:"textarea",rows:3,placeholder:"Enter term *",value:s,onChange:a=>J(t,a.target.value)})}),e.jsx(m,{lg:12,className:"d-flex justify-content-end",children:e.jsx(p,{variant:"danger",size:"sm",onClick:()=>W(t),children:"Remove Term"})})]},t)),e.jsx(p,{variant:"secondary",onClick:O,className:"mt-2",children:"Add Term"})]})}),e.jsxs("div",{style:{display:"flex",flexDirection:"row",gap:10},children:[e.jsx(p,{variant:"primary",onClick:z,className:"mt-3",children:"Add Main Item"}),e.jsx(p,{variant:"success",onClick:K,className:"mt-3",children:"Update Invoice"})]})]})})]})};export{ve as default};
