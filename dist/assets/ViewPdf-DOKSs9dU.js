import{f as _,u as z,b as Q,r as d,j as e,R as V}from"./index-hhKMM5af.js";import{a as P}from"./index-C88pvD_q.js";import{r as i}from"./riyal_icon-CI4jK9IE.js";import{S as F,b as D}from"./authConstant-D7ccvCuz.js";import{C as u}from"./Container-ColgPtdt.js";import{A as p}from"./Alert-CGrySj3C.js";import{B as y}from"./Button-CwuV16Mp.js";import{C as r}from"./Card-CIyWpKf_.js";import{T as O}from"./Table-Cggsgo-9.js";import{B as o}from"./ListGroup-HIRppqna.js";import"./hook-DpPTRFBK.js";import"./extends-CF3RwP-h.js";import"./divWithClassName-IzdvHqeb.js";import"./Anchor-CDjO9hfG.js";import"./useEventCallback-3DrfGeCB.js";import"./Button-Ccp68HYs.js";import"./CardHeaderContext-NYcVvM35.js";import"./Nav-CL4XdSPs.js";import"./DataKey-COGXBUcQ.js";import"./NavContext-Dm1lLql2.js";import"./useMergedRefs-C_BGB1CU.js";import"./NavItem-Dg0o_Q2m.js";const je=()=>{const{id:a}=_(),C=z(),{user:h}=Q(),[m,A]=d.useState(null),[B,T]=d.useState(!0),[w,f]=d.useState(""),[x,v]=d.useState(!1);d.useEffect(()=>{h&&(async()=>{try{console.log("Fetching invoice with ID:",a);const s=await P.get(`${D}/quotation/${a}`,{headers:{Authorization:`Bearer ${h.token}`}});console.log("Fetch response:",s.data),s.status===200&&A(s.data.data)}catch(s){console.error("Error fetching invoice:",s),f("Failed to fetch invoice details. Please try again.")}finally{T(!1)}})()},[a,h]);const N=async()=>{v(!0),f(""),console.log("Starting PDF generation for invoice ID:",a);try{const t=await P.get(`${D}/quotation/${a}/pdf`,{headers:{Authorization:`Bearer ${h.token}`},timeout:3e4});if(console.log("PDF response:",t.data),!t.data.success)throw new Error(t.data.error||"Failed to generate PDF");const s=t.data.pdf;if(!s)throw new Error("No PDF data received from server");const c=atob(s),n=new Uint8Array(c.length);for(let j=0;j<c.length;j++)n[j]=c.charCodeAt(j);const g=new Blob([n],{type:"application/pdf"}),b=window.URL.createObjectURL(g),l=document.createElement("a");l.href=b,l.download=`ISC Quotation_${m.companyName}_${m.quotationNumber}.pdf`,document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(b),console.log("PDF download initiated successfully")}catch(t){console.error("PDF generation error:",t),f(t.message||"Failed to generate PDF. Please try again.")}finally{v(!1),console.log("PDF loading state reset")}},I=()=>{C(`/quotation/edit/${a}`)};if(B)return e.jsx(u,{className:"d-flex justify-content-center align-items-center vh-100",children:e.jsx(F,{animation:"border",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})});if(w&&!x)return e.jsx(u,{className:"d-flex justify-content-center align-items-center vh-100",children:e.jsxs(p,{variant:"danger",children:[w,e.jsx(y,{variant:"link",onClick:N,children:"Retry"})]})});if(!m)return e.jsx(u,{className:"d-flex justify-content-center align-items-center vh-100",children:e.jsx(p,{variant:"warning",children:"No invoice found."})});const{companyName:S,date:L,quotationNumber:E,items:q,terms:$,totalPrice:k,VATAmount:R,finalAmount:G}=m,U=new Date(L).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"});return e.jsx(u,{className:"my-5",children:e.jsxs(r,{children:[e.jsx(r.Header,{as:"h1",className:"text-center",children:"Invoice Details"}),e.jsxs(r.Body,{children:[e.jsxs("div",{className:"d-flex justify-content-end mb-4",children:[e.jsx(y,{variant:"primary",onClick:I,className:"me-2",children:"Edit Quotation"}),e.jsx(y,{variant:"success",onClick:N,disabled:x,children:x?e.jsxs(e.Fragment,{children:[e.jsx(F,{as:"span",animation:"border",size:"sm",role:"status","aria-hidden":"true"})," ","Generating PDF..."]}):"Generate PDF"})]}),x&&e.jsx(p,{variant:"info",className:"text-center",children:"Generating PDF, please wait..."}),e.jsx(r,{className:"mb-4",children:e.jsxs(r.Body,{children:[e.jsxs(r.Title,{children:["Company: ",S]}),e.jsxs(r.Text,{children:[e.jsx("strong",{children:"Invoice Number:"})," ",E,e.jsx("br",{}),e.jsx("strong",{children:"Date:"})," ",U]})]})}),e.jsx(r,{className:"mb-4",children:e.jsxs(r.Body,{children:[e.jsx(r.Title,{children:"Items"}),e.jsxs(O,{striped:!0,bordered:!0,hover:!0,responsive:!0,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Quantity"}),e.jsx("th",{children:"Price"}),e.jsx("th",{children:"Total"}),e.jsx("th",{children:"Image"})]})}),e.jsx("tbody",{children:q.map((t,s)=>{const c=1+t.subItems.length;return e.jsxs(V.Fragment,{children:[e.jsxs("tr",{children:[e.jsx("td",{children:t.name}),e.jsx("td",{className:"text-center",children:t.quantity}),e.jsxs("td",{className:"text-end flex flex-row",children:[e.jsx("img",{src:i,width:10,height:12}),t.price]}),e.jsxs("td",{className:"text-end flex flex-row",children:[e.jsx("img",{src:i,width:10,height:12}),t.quantity*t.price]}),e.jsx("td",{rowSpan:c,style:{textAlign:"center"},children:t.image&&e.jsx("img",{src:t.image,alt:t.name,style:{width:"80px",height:"auto"}})})]}),t.subItems.map((n,g)=>e.jsxs("tr",{children:[e.jsxs("td",{style:{paddingLeft:"30px"},children:[String.fromCharCode(97+g),"."," ",n.name]}),e.jsx("td",{className:"text-center",children:n.quantity}),e.jsxs("td",{className:"text-end flex flex-row",children:[e.jsx("img",{src:i,width:10,height:12}),n.price]}),e.jsxs("td",{className:"text-end flex flex-row",children:[e.jsx("img",{src:i,width:10,height:12}),n.quantity*n.price]})]},n._id))]},s)})})]})]})}),e.jsx(r,{className:"mb-4",children:e.jsxs(r.Body,{children:[e.jsx(r.Title,{children:"Totals"}),e.jsxs(o,{variant:"flush",children:[e.jsxs(o.Item,{children:[e.jsx("strong",{children:"Total Price:"})," ",e.jsx("img",{src:i,width:10,height:12}),k]}),e.jsxs(o.Item,{children:[e.jsx("strong",{children:"VAT Amount:"})," ",e.jsx("img",{src:i,width:10,height:12}),R]}),e.jsxs(o.Item,{children:[e.jsx("strong",{children:"Final Amount:"})," ",e.jsx("img",{src:i,width:10,height:12}),G]})]})]})}),e.jsx(r,{children:e.jsxs(r.Body,{children:[e.jsx(r.Title,{children:"Terms and Conditions"}),e.jsx(o,{variant:"flush",children:$.map((t,s)=>e.jsx(o.Item,{children:t},s))})]})})]})]})})};export{je as default};
