import{b as V,u as W,f as X,r as i,j as e,T as Y,e as D}from"./index-CQD1z6Fx.js";import{P as Z}from"./PageTitle-CtZGw2bx.js";import{S as R,b as q}from"./authConstant-Cc9JzxD5.js";import{C as U,a as O}from"./Card--fiRGSee.js";import{F as ee}from"./Form-D_tiZ0-p.js";import{R as P,C as S}from"./Row-DR6tWxXV.js";import{F as h,a as p}from"./FormLabel-Dy83DiRD.js";import{F as y}from"./FormControl-B161gUqv.js";import{B as C}from"./Button-C4dcH4PN.js";import"./CardHeaderContext-CLFReu40.js";import"./divWithClassName-DI2ioJPZ.js";import"./FormCheck-fxkujzDx.js";import"./FormContext-jf0KNw1i.js";import"./ElementChildren-CTEE3YrK.js";import"./Button-BXfs0ALN.js";const fe=()=>{const{user:c}=V(),d=W(),{id:f}=X(),r=!!f,[v,E]=i.useState(""),[w,F]=i.useState(""),[j,T]=i.useState(""),[o,x]=i.useState([{description:"",quantity:""}]),[_,g]=i.useState(!1),[z,M]=i.useState(""),[I,k]=i.useState(!1),[Q,$]=i.useState(r);i.useEffect(()=>{c||d("/auth/login")},[c,d]),i.useEffect(()=>{r&&c&&c.token&&(async()=>{$(!0);try{const s=await fetch(`${q}/deliveries/${f}`,{headers:{Authorization:`Bearer ${c.token}`,"Content-Type":"application/json"}}),a=await s.json();if(s.ok&&a.success)E(a.data.companyName||""),F(a.data.date?new Date(a.data.date).toISOString().split("T")[0]:""),T(a.data.deliveryNumber||""),x(Array.isArray(a.data.items)?a.data.items.map(l=>({description:l.description||"",quantity:l.quantity||""})):[{description:"",quantity:""}]);else throw new Error(a.error||"Failed to fetch delivery")}catch(s){console.error("Error fetching delivery:",s),n(s.message||"Failed to fetch delivery."),d("/delivery-note")}finally{$(!1)}})()},[f,r,c,d]);const G=()=>{x([...o,{description:"",quantity:""}])},H=t=>{o.length>1?x(o.filter((s,a)=>a!==t)):n("At least one item is required")},A=(t,s,a)=>{const l=[...o];l[t][s]=a,x(l)},n=t=>{M(t),g(!0),setTimeout(()=>g(!1),3e3)},J=async()=>{if(g(!1),!v.trim()){n("Company Name is required.");return}if(!w){n("Date is required.");return}if(!j.trim()){n("Delivery Number is required.");return}for(let t=0;t<o.length;t++){const s=o[t];if(!s.description.trim()){n(`Item ${t+1}: Description is required.`);return}if(!s.quantity||isNaN(s.quantity)||Number(s.quantity)<=0){n(`Item ${t+1}: Quantity must be a positive number.`);return}}k(!0);try{const t={companyName:v,date:w,deliveryNumber:j,items:o.map(m=>({description:m.description,quantity:parseInt(m.quantity)}))},s=r?`${q}/deliveries/${f}`:`${q}/deliveries/generate`,l=await fetch(s,{method:r?"PUT":"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c.token}`},body:JSON.stringify(t)}),N=await l.json();if(l.ok&&N.success){if(!r&&N.pdf){const m=atob(N.pdf),B=new Uint8Array(m.length);for(let b=0;b<m.length;b++)B[b]=m.charCodeAt(b);const K=new Blob([B],{type:"application/pdf"}),L=window.URL.createObjectURL(K),u=document.createElement("a");u.href=L,u.download=`Delivery_Note_${v}_${j}.pdf`,document.body.appendChild(u),u.click(),u.remove(),window.URL.revokeObjectURL(L)}n(r?"Delivery updated successfully!":"Delivery created and downloaded successfully!"),setTimeout(()=>d("/delivery-note"),1e3)}else throw new Error(N.error||"Failed to save delivery")}catch(t){console.error("Error saving delivery:",t),n(t.message||"Failed to save delivery.")}finally{k(!1)}};return Q?e.jsx("div",{className:"text-center mt-5",children:e.jsx(R,{animation:"border"})}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{position:"top-end",className:"p-3",children:e.jsxs(D,{show:_,onClose:()=>g(!1),delay:3e3,autohide:!0,children:[e.jsx(D.Header,{children:e.jsx("strong",{className:"me-auto",children:"Notification"})}),e.jsx(D.Body,{children:z})]})}),e.jsx(Z,{title:r?"Edit Delivery":"Create Delivery"}),e.jsx(U,{children:e.jsxs(O,{children:[e.jsx("h4",{className:"delivery-form-title",children:r?"Edit Delivery Note":"Create Delivery Note"}),e.jsxs(ee,{children:[e.jsx(P,{children:e.jsxs(S,{lg:12,children:[e.jsxs(h,{className:"mb-3",children:[e.jsx(p,{children:"Company Name *"}),e.jsx(y,{placeholder:"Enter company name",value:v,onChange:t=>E(t.target.value)})]}),e.jsxs(h,{className:"mb-3",children:[e.jsx(p,{children:"Date *"}),e.jsx(y,{type:"date",value:w,onChange:t=>F(t.target.value)})]}),e.jsxs(h,{className:"mb-3",children:[e.jsx(p,{children:"Delivery Number *"}),e.jsx(y,{placeholder:"Enter delivery number",value:j,onChange:t=>T(t.target.value)})]})]})}),e.jsx("h5",{className:"mt-4",children:"Items"}),o.map((t,s)=>e.jsx(U,{className:"mb-3",children:e.jsxs(O,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("h6",{children:["Item ",s+1]}),e.jsx(C,{variant:"danger",size:"sm",onClick:()=>H(s),children:"Remove"})]}),e.jsxs(P,{children:[e.jsx(S,{lg:8,children:e.jsxs(h,{className:"mb-3",children:[e.jsx(p,{children:"Description *"}),e.jsx(y,{placeholder:"Enter item description",value:t.description,onChange:a=>A(s,"description",a.target.value)})]})}),e.jsx(S,{lg:4,children:e.jsxs(h,{className:"mb-3",children:[e.jsx(p,{children:"Quantity *"}),e.jsx(y,{type:"number",min:"1",placeholder:"Enter quantity",value:t.quantity,onChange:a=>A(s,"quantity",a.target.value)})]})})]})]})},s)),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(C,{variant:"secondary",onClick:()=>d("/delivery-note"),className:"mt-3",children:"Cancel"}),e.jsx(C,{variant:"primary",onClick:G,className:"mt-3",children:"Add Item"}),e.jsx(C,{variant:"success",onClick:J,className:"mt-3",disabled:I,children:I?e.jsxs(e.Fragment,{children:[e.jsx(R,{as:"span",animation:"border",size:"sm",role:"status","aria-hidden":"true",className:"me-2"}),r?"Updating...":"Creating..."]}):r?"Update Delivery":"Create Delivery"})]})]})]})})]})};export{fe as default};
