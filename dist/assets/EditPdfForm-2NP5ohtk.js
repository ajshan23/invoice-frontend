import{r as c,u as W,f as J,j as e,T as K,e as q}from"./index-BIHaN3sb.js";import{l as V}from"./cropper-BLCYGBqp.js";/* empty css                      */import{a as A}from"./index-C88pvD_q.js";import{C as S,a as I}from"./Card-B1-Rx35N.js";import{R as y,C as d}from"./Row-yYV4Yy1W.js";import{F as n}from"./FormControl-LAKOqjRP.js";import{B as v}from"./Button-CuQYO7Ah.js";import"./CardHeaderContext-WEXKzZ8-.js";import"./divWithClassName-wfmF57ny.js";import"./FormContext-CLNhOJYs.js";import"./Button-t0qNR9Tr.js";const le=()=>{const[x,D]=c.useState(""),[u,F]=c.useState(""),[C,E]=c.useState(""),[l,h]=c.useState([]),[p,b]=c.useState([""]),[B,f]=c.useState(!1),[P,k]=c.useState(""),_=W(),{id:N}=J(),R=c.useRef({}),[j,w]=c.useState({});c.useEffect(()=>{(async()=>{try{const t=await A.get(`http://185.199.53.88/api/invoice/${N}`);if(t.data.success&&t.data.data){const a=t.data.data;D(a.companyName);const o=new Date(a.date).toISOString().split("T")[0];F(o),E(a.invoiceNumber),h(a.items),b(a.terms||[""]);const r={};a.items.forEach((i,O)=>{i.image&&(r[O]=!0)}),w(r)}}catch(t){console.error("Error fetching invoice:",t),m("Failed to load invoice data")}})()},[N]);const M=()=>{const s={name:"",price:0,quantity:1,image:"",subItems:[]};h([...l,s])},g=(s,t,a)=>{const o=[...l];if(o[s][t]=a,h(o),t==="image"){const r={...j};delete r[s],w(r)}},U=s=>{const t=[...l];t[s].subItems.push({name:"",price:0,quantity:1}),h(t)},T=(s,t,a,o)=>{const r=[...l];r[s].subItems[t][a]=o,h(r)},L=(s,t)=>{const a=t.target.files[0];if(a){const o=new FileReader;o.onload=()=>{g(s,"image",o.result)},o.readAsDataURL(a)}},H=(s,t)=>{t&&(R.current[s]=t)},Q=s=>{const t=R.current[s];if(t){const a=t.getCroppedCanvas({width:150,height:300});if(a){const o=a.toDataURL();g(s,"image",o),w({...j,[s]:!0})}}},$=()=>{b([...p,""])},z=(s,t)=>{const a=[...p];a[s]=t,b(a)},m=s=>{k(s),f(!0),setTimeout(()=>f(!1),3e3)},G=async()=>{var s,t;if(f(!1),!x||!u||!C){m("Company Name, Date, and Invoice Number are required."),window.scrollTo({top:0,behavior:"smooth"});return}if(l.length===0){m("At least one main item is required."),window.scrollTo({top:0,behavior:"smooth"});return}for(let a=0;a<l.length;a++){const o=l[a];if(!o.name||!o.price||!o.quantity){m("All main item fields are required."),window.scrollTo({top:0,behavior:"smooth"});return}if(!o.image||!j[a]){m("Please upload and crop an image for all main items."),window.scrollTo({top:0,behavior:"smooth"});return}for(let r=0;r<o.subItems.length;r++){const i=o.subItems[r];if(!i.name||!i.price||!i.quantity){m("All sub-item fields are required."),window.scrollTo({top:0,behavior:"smooth"});return}}}if(p.length===0||p.some(a=>!a.trim())){m("At least one term is required."),window.scrollTo({top:0,behavior:"smooth"});return}try{const a={companyName:x,date:u,invoiceNumber:C,items:l.map(r=>({name:r.name,price:parseFloat(r.price),quantity:parseInt(r.quantity),image:r.image,subItems:r.subItems.map(i=>({name:i.name,price:parseFloat(i.price),quantity:parseInt(i.quantity),_id:i._id})),_id:r._id})),terms:p.filter(r=>r.trim())},o=await A.put(`http://185.199.53.88/api/invoice/${N}`,a,{headers:{"Content-Type":"application/json"}});if(!o.data.success)throw new Error(o.data.error||"Failed to update invoice");m("Invoice updated successfully!"),_("/pdf")}catch(a){console.error("Error updating PDF:",a),m(((t=(s=a.response)==null?void 0:s.data)==null?void 0:t.error)||"Failed to update invoice. Please try again."),window.scrollTo({top:0,behavior:"smooth"})}};return e.jsxs(e.Fragment,{children:[e.jsx(K,{position:"top-end",className:"p-3",children:e.jsxs(q,{onClose:()=>f(!1),show:B,delay:3e3,autohide:!0,children:[e.jsx(q.Header,{children:e.jsx("strong",{className:"me-auto",children:"Notification"})}),e.jsx(q.Body,{children:P})]})}),e.jsx(S,{children:e.jsxs(I,{children:[e.jsx("h4",{children:"Edit Invoice"}),e.jsx(y,{children:e.jsxs(d,{lg:12,children:[e.jsx(n,{placeholder:"Company Name *",value:x,onChange:s=>D(s.target.value),className:"mb-3"}),e.jsx(n,{type:"date",value:u,onChange:s=>F(s.target.value),className:"mb-3",required:!0}),u&&e.jsxs("small",{className:"text-muted mb-3 d-block",children:["Selected Date:"," ",new Date(u).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g," / ")]}),e.jsx(n,{placeholder:"Invoice Number *",value:C,onChange:s=>E(s.target.value),className:"mb-3"})]})}),l.map((s,t)=>e.jsx(S,{className:"mb-3",children:e.jsxs(I,{children:[e.jsxs(y,{children:[e.jsxs(d,{lg:6,children:[e.jsx(n,{placeholder:"Item Name *",value:s.name,onChange:a=>g(t,"name",a.target.value),className:"mb-3"}),e.jsx(n,{type:"number",placeholder:"Price *",value:s.price,onChange:a=>g(t,"price",a.target.value),className:"mb-3"}),e.jsx(n,{type:"number",placeholder:"Quantity *",value:s.quantity,onChange:a=>g(t,"quantity",a.target.value),className:"mb-3"})]}),e.jsxs(d,{lg:6,children:[e.jsx(n,{type:"file",accept:"image/*",onChange:a=>L(t,a),className:"mb-3"}),s.image&&e.jsxs(e.Fragment,{children:[e.jsx(V,{src:s.image,style:{height:200,width:"100%"},aspectRatio:1/2,guides:!0,viewMode:1,minCropBoxWidth:150,minCropBoxHeight:300,onInitialized:a=>H(t,a)}),e.jsxs("div",{className:"mt-2 mb-2 d-flex justify-content-between align-items-center",children:[e.jsx("small",{className:"text-muted",children:"Cropping to 150x300 aspect ratio"}),j[t]&&e.jsx("span",{className:"text-success",children:"âœ“ Image cropped"})]}),e.jsx(v,{variant:"info",onClick:()=>Q(t),className:"mt-2",children:"Apply Crop"})]})]})]}),s.subItems.map((a,o)=>e.jsxs(y,{className:"mt-3",children:[e.jsx(d,{lg:4,children:e.jsx(n,{placeholder:"Sub-Item Name *",value:a.name,onChange:r=>T(t,o,"name",r.target.value),className:"mb-3"})}),e.jsx(d,{lg:4,children:e.jsx(n,{type:"number",placeholder:"Price *",value:a.price,onChange:r=>T(t,o,"price",r.target.value),className:"mb-3"})}),e.jsx(d,{lg:4,children:e.jsx(n,{type:"number",placeholder:"Quantity *",value:a.quantity,onChange:r=>T(t,o,"quantity",r.target.value),className:"mb-3"})})]},a._id||o)),e.jsx(v,{variant:"secondary",onClick:()=>U(t),className:"mt-2",children:"Add Sub-Item"})]})},s._id||t)),e.jsx(S,{className:"mb-3",children:e.jsxs(I,{children:[e.jsx("h5",{children:"Terms and Conditions"}),p.map((s,t)=>e.jsx(y,{className:"mb-3",children:e.jsx(d,{lg:12,children:e.jsx(n,{as:"textarea",rows:3,placeholder:"Enter term *",value:s,onChange:a=>z(t,a.target.value)})})},t)),e.jsx(v,{variant:"secondary",onClick:$,className:"mt-2",children:"Add Term"})]})}),e.jsxs("div",{style:{display:"flex",flexDirection:"row",gap:10},children:[e.jsx(v,{variant:"primary",onClick:M,className:"mt-3",children:"Add Main Item"}),e.jsx(v,{variant:"success",onClick:G,className:"mt-3",children:"Update Invoice"})]})]})})]})};export{le as default};
